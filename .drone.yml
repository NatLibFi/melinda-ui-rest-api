---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push

steps:

  - name: generate-tags
    image: quay.io/natlibfi/drone-gen-tags

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --audit-level=moderate --production

  - name: install
    image: node:12
    commands:
      - npm ci
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true

  - name: test
    image: node:12
    commands:
      - npm test

  # No tests
  #- name: check-coverage
  #  image: node:12
  #  commands:
  #    - npm run check-coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - NPM_CONFIG_IGNORE_SCRIPTS=true npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/njsscan
    commands:
      - njsscan dist

  - name: docker
    image: plugins/docker
    settings:
      repo: quay.io/natlibfi/melinda-user-tools
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password

---
kind: secret
name: docker_username
data: vBa1cv8GcOWs1yZJKm8GlxEjIapUzl5x6r5MbvXtX2Xz8XqSZx/mzIlypxMuJvTbj0k=
---
kind: secret
name: docker_password
data: DYMF/b1Crgs/H8xLi9eoDfie3Lai793Of2Gl0TNr2SO6Z/CQWUjVZOKFqYj8RmGVvCGRYejqiNuJVQuqmh9lIAPtOWSH64SjDTDbKGz5oitVml4tbN2f6bc0fi8=
---
kind: signature
hmac: e2a7ee3f5cc341f3d69f9a2c5de42c830585a3f6d3d9ce3c53c0e1e48d73554e

...
